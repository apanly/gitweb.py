import os
import time
import hashlib
import git
import web
from web import form
from decorators import requires_login

render = web.template.render(
    'templates/',
    base='main',
    globals={'time':time, 'session':web.config.session})

create_repo_form = form.Form(
    form.Dropdown("owner", args=["Yourself", "Some Project"], description="Owner"),
    form.Textbox("name", description="Name"),
    form.Textbox("id", description="id"),
    form.Textarea("desc", description="Description"),
    form.Radio("access", ["public", "private"], description="Access"),
    form.Button("submit", type="submit", description="Create repository"))

class create:
    @requires_login
    def GET(self):
        userid = web.config.session.userid
        project_query = web.config.db.select('project_users', dict(u=userid), where="userid=$u", what="projectid")
        projectids = [p.projectid for p in project_query]
        projectids = [userid] + projectids
        create_repo_form['owner'].args = projectids
        return render.createRepo(create_repo_form)

    @requires_login
    def POST(self):
        f = create_repo_form()
        if not f.validates():
            return render.createRepo(f)

        v = dict(o=f.d.owner, i=f.d.id)
        u = web.config.db.select('repositories', v, where="id=$i and owner=$o", what="id").list()
        if len(u) != 0:
            return web.internalerror("Invalid repository id. Repository already exists.")

        repoPath = os.path.join("repositories", f.d.owner, f.d.id + ".git")
        if os.path.exists(repoPath):
            print "Repository already exists."
            return web.internalerror("Repository already exists.")

        web.config.db.query("pragma foreign_keys=ON") # making sure constraints are enforced
        transaction = web.config.db.transaction()
        try:
            web.config.db.insert('repositories', id=f.d.id, name=f.d.name, owner=f.d.owner, description=f.d.desc, access=f.d.access)
            web.config.db.insert('repo_users', repoid=f.d.id, repoowner=f.d.owner, userid=f.d.owner, access='admin')

            git.Repo.init(repoPath, bare=True)
            
            transaction.commit()
            return web.seeother("/%s/%s" % (f.d.owner, f.d.id))
        except Exception, e:
            transaction.rollback()
            print e
            return web.internalerror("Couldn't create repository")

